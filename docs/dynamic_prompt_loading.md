# Dynamic Prompt Loading Implementation

## Overview
The `get_system_prompt()` function in `task2.py` now **dynamically loads** the optimized prompt from `experiments/prompt_optimization/best_prompt.txt` instead of having it hardcoded.

## Implementation Details

### File: `src/app/prompts/task2.py`

The function now:
1. **Attempts to load** the optimized prompt from `best_prompt.txt`
2. **Validates** the loaded content (checks for "CRITICAL INSTRUCTIONS")
3. **Falls back** to a default prompt if the file doesn't exist or is invalid

```python
def get_system_prompt() -> str:
    """System prompt for Task 2 scoring with evidence-first JSON-only constraints.
    
    This prompt is loaded from the optimized best_prompt.txt file generated by the
    prompt optimizer. If the file doesn't exist, falls back to a default prompt.
    """
    # Try to load optimized prompt
    best_prompt_path = Path(__file__).parents[3] / "experiments" / "prompt_optimization" / "best_prompt.txt"
    
    if best_prompt_path.exists():
        try:
            optimized_prompt = best_prompt_path.read_text(encoding="utf-8").strip()
            if optimized_prompt and "CRITICAL INSTRUCTIONS" in optimized_prompt:
                return optimized_prompt
        except Exception as e:
            logging.warning(f"Failed to load optimized prompt: {e}")
    
    # Fallback to default prompt
    return f"""..."""
```

## Benefits

### 1. **Automatic Updates**
- When you run prompt optimization and generate a new `best_prompt.txt`, it's automatically used in production
- No manual code changes needed

### 2. **Safe Fallback**
- If the optimized prompt file is missing or corrupted, falls back to a working default
- Ensures the system always has a valid prompt

### 3. **Easy Experimentation**
- Swap different prompt versions by replacing `best_prompt.txt`
- Test new prompts without touching the code

### 4. **Version Control**
- Can track prompt evolution through `best_prompt.txt` file history
- Prompt changes are separate from code changes

## Current Prompt Status

**Optimized Prompt Loaded:** ✓
- **Length:** 2,120 chars (vs 1,066 chars default, +99% improvement)
- **Sections Added:**
  - BAND DESCRIPTORS ✓
  - ERROR CALIBRATION ✓
  - SCORING CALIBRATION ✓
  - COMMON PITFALLS ✓

**Test Results:**
- Prompt loads successfully from file
- Scoring pipeline works correctly
- Fallback mechanism verified

## Usage

### Normal Operation
```python
from src.app.prompts.task2 import get_system_prompt

# Automatically loads from best_prompt.txt if available
prompt = get_system_prompt()
```

### After Prompt Optimization
```bash
# Run optimization
python -m prompt_optimizer optimize --samples 30 --iterations 5

# The new best_prompt.txt is automatically used on next run
# No code changes needed!
```

### Manual Prompt Update
If you want to use a specific prompt:
```bash
# Simply replace the file
cp my_custom_prompt.txt experiments/prompt_optimization/best_prompt.txt
```

## File Path
The optimized prompt is loaded from:
```
experiments/prompt_optimization/best_prompt.txt
```

This is the output of the prompt optimizer's `optimize` command.

## Workflow

1. **Initial State:** Uses default fallback prompt
2. **Run Optimization:** `python -m prompt_optimizer optimize`
3. **Automatic Activation:** New prompt is immediately available
4. **Continuous Improvement:** Re-run optimizer to further refine
5. **Production Ready:** Always uses the latest optimized prompt

---

**Status:** ✅ Implemented and Tested
**Date:** October 11, 2025
